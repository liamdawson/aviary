---
- name: enable bumblebee repo
  become: yes
  command: dnf copr enable chenxiaolong/bumblebee -y
  args:
    creates: /etc/yum.repos.d/_copr_chenxiaolong-bumblebee.repo

- name: install bumblebee
  become: yes
  package:
    name:
      - akmod-bbswitch
      - bumblebee
      - primus
    state: present
  register: bumblebee_packages

- name: reload systemd daemon
  become: yes
  when: bumblebee_packages.changed
  systemd:
    daemon_reload: yes

- name: enable bumblebee
  become: yes
  systemd:
    name: bumblebeed
    masked: no
    enabled: yes

- name: disable nouveau fallback
  become: yes
  systemd:
    name: nvidia-fallback
    masked: yes
    state: stopped

- name: add user to bumblebee group
  become: yes
  user:
    name: "{{ ansible_user }}"
    append: yes
    groups:
      - bumblebee
